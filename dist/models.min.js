var Shareabouts=Shareabouts||{};(function(t,e){"use strict";var n=function(t,e,n){var o;return null===t||_.isObject(t)?(o=t,n=e):null!==t&&((o={})[t]=e),n=n?_.clone(n):{},{options:n,attrs:o}};t.ShareaboutsApiModel=Backbone.Model.extend({sync:function(t,e,n){if("read"!==t){var o=e.toJSON();delete o.created_datetime,delete o.dataset,delete o.id,delete o.updated_datetime,delete o.distance,n=n||{},n.contentType="application/json",n.data=JSON.stringify(o)}Backbone.sync(t,e,n)}}),t.SubmissionModel=t.ShareaboutsApiModel.extend({url:function(){var e=t.SubmissionModel.__super__.url.call(this);return e+="/"===e.charAt(e.length-1)?"":"/"}}),t.SubmissionCollection=Backbone.Collection.extend({initialize:function(t,e){this.options=e},model:t.SubmissionModel,url:function(){var t=this.options.submissionType,e=this.options.placeModel.id;if(!e)throw Error("Place model id is not defined. You must save the Place before saving its "+t+".");return"/api/places/"+e+"/"+t+"/"}}),t.PlaceModel=t.ShareaboutsApiModel.extend({initialize:function(){var e=this,n=this.get("submissions")||[],o=[],i=[];_.each(n,function(t){var n;_.isArray(t)&&(n=_.first(t).type,n===e.collection.options.responseType?o=t:n===e.collection.options.supportType&&(i=t))}),this.responseCollection=new t.SubmissionCollection(o,{placeModel:this,submissionType:this.collection.options.responseType}),this.supportCollection=new t.SubmissionCollection(i,{placeModel:this,submissionType:this.collection.options.supportType});var a=this.get("attachments")||[];this.attachmentCollection=new t.AttachmentCollection(a,{thingModel:this})},set:function(e,o,i){var a=n(e,o,i),s=this;return _.isArray(a.attrs.attachments)&&this.attachmentCollection&&!a.options.ignoreAttachnments&&this.attachmentCollection.reset(a.attrs.attachments),_.each(a.attrs.submissions,function(t){var e;_.isArray(t)&&(e=_.first(t).type,e===s.collection.options.responseType&&s.responseCollection?s.responseCollection.reset(t):e===s.collection.options.supportType&&s.supportCollection&&s.supportCollection.reset(t))}),t.PlaceModel.__super__.set.call(this,a.attrs,a.options)},save:function(o,i,a){var s,r=this,c=n(o,i,a),l=c.attrs;a=c.options,this.isNew()?(s=a.success||e.noop,a.success=function(){r.saveAttachments(),s.apply(this,arguments)}):r.saveAttachments(),a.ignoreAttachnments=!0,t.PlaceModel.__super__.save.call(this,l,a)},saveAttachments:function(){this.attachmentCollection.each(function(t){t.isNew()&&t.save()})}}),t.PlaceCollection=Backbone.Collection.extend({url:"/api/places/",model:t.PlaceModel,initialize:function(t,e){this.options=e},add:function(e,n){return n=n||{},n.responseType=this.options&&this.options.responseType,n.supportType=this.options&&this.options.supportType,t.PlaceCollection.__super__.add.call(this,e,n)}}),t.AttachmentModel=Backbone.Model.extend({idAttr:"name",initialize:function(t,e){this.options=e},save:function(t,e,o){var i=n(t,e,o),a=_.extend(this.attributes,i.attrs);return this._attachBlob(a.blob,a.name,i.options)},_attachBlob:function(n,o,i){var a=new FormData,s=t.Util.wrapHandler("progress",this,i.progress),r=e.ajaxSettings.xhr();a.append("file",n),a.append("name",o),i=i||{},e.ajax({url:this.collection.url(),type:"POST",xhr:function(){return r.upload&&r.upload.addEventListener("progress",s,!1),r},success:i.success,error:i.error,data:a,cache:!1,contentType:!1,processData:!1})}}),t.AttachmentCollection=Backbone.Collection.extend({model:t.AttachmentModel,initialize:function(t,e){this.options=e},url:function(){var t=this.options.thingModel,e=t.url();return e+"/attachments/"}}),t.ActivityCollection=Backbone.Collection.extend({url:"/api/activity/"})})(Shareabouts,jQuery,Shareabouts.Util.console),jQuery(document).ajaxSend(function(t,e,n){function o(t){var e=null;if(document.cookie&&""!==document.cookie)for(var n=document.cookie.split(";"),o=0;n.length>o;o++){var i=jQuery.trim(n[o]);if(i.substring(0,t.length+1)===t+"="){e=decodeURIComponent(i.substring(t.length+1));break}}return e}function i(t){var e=document.location.host,n=document.location.protocol,o="//"+e,i=n+o;return t==i||t.slice(0,i.length+1)==i+"/"||t==o||t.slice(0,o.length+1)==o+"/"||!/^(\/\/|http:|https:).*/.test(t)}function a(t){return/^(GET|HEAD|OPTIONS|TRACE)$/.test(t)}!a(n.type)&&i(n.url)&&e.setRequestHeader("X-CSRFToken",o("csrftoken")),"DELETE"===n.type&&(e.setRequestHeader("Content-Type","application/json"),n.data="{}")});