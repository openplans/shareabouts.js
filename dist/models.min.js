var Shareabouts=Shareabouts||{};(function(t,e){"use strict";var n=function(t,e,n){var a;return null===t||_.isObject(t)?(a=t,n=e):null!==t&&((a={})[t]=e),n=n?_.clone(n):{},{options:n,attrs:a}};t.PaginatedCollection=Backbone.Collection.extend({resultsAttr:"results",parse:function(t){return this.metadata=t.metadata,t[this.resultsAttr]},fetchNextPage:function(t,e){var n=this;this.metadata.next&&n.fetch({remove:!1,url:n.metadata.next,success:t,error:e})},fetchAllPages:function(t){var e,n,a,s,r,i,o=this,c=0,l=1;t=t||{},t.data=t.data||{},t.error&&(i=_.once(t.error)),e=function(e,i){var c,u=i[o.resultsAttr].length;if(l=Math.ceil(i.metadata.length/u),t.success&&(r=_.after(l,t.success)),i.metadata.next)for(c=2;l>=c;c++)o.fetch(_.defaults({remove:!1,data:_.defaults({page:c},t.data),complete:n,success:a,error:s},t));a.apply(this,arguments)},n=function(){c++,t.pageComplete&&t.pageComplete.apply(this,arguments),c===l&&t.complete&&t.complete.apply(this,arguments)},a=function(){t.pageSuccess&&t.pageSuccess.apply(this,arguments),r&&r.apply(this,arguments)},s=function(){t.pageError&&t.pageError.apply(this,arguments),i&&i.apply(this,arguments)},this.fetch(_.defaults({success:e,error:s,complete:n},t))}}),t.SubmissionCollection=t.PaginatedCollection.extend({initialize:function(t,e){this.options=e},url:function(){var t=this.options.submissionType,e=this.options.placeModel&&this.options.placeModel.id;if(!t)throw Error("submissionType option is required.");if(!e)throw Error("Place model id is not defined. You must save the place before saving its "+t+".");return"/api/places/"+e+"/"+t},comparator:"created_datetime"}),t.PlaceModel=Backbone.Model.extend({initialize:function(){var e;this.submissionSets={},_.each(this.get("submission_sets"),function(e,n){var a=[];_.isArray(e)&&(a=e),this.submissionSets[n]=new t.SubmissionCollection(a,{submissionType:n,placeModel:this})},this),e=this.get("attachments")||[],this.attachmentCollection=new t.AttachmentCollection(e,{thingModel:this}),this.attachmentCollection.each(function(t){t.set({saved:!0})})},set:function(e,a,s){var r=n(e,a,s);return _.isArray(r.attrs.attachments)&&this.attachmentCollection&&!r.options.ignoreAttachments&&this.attachmentCollection.reset(r.attrs.attachments),_.each(r.attrs.submission_sets,function(t,e){this.submissionSets&&this.submissionSets[e]&&_.isArray(t)&&this.submissionSets[e].reset(t)},this),t.PlaceModel.__super__.set.call(this,r.attrs,r.options)},save:function(a,s,r){var i,o=this,c=n(a,s,r),l=c.attrs;r=c.options,this.isNew()?(i=r.success||e.noop,r.success=function(){o.saveAttachments(),i.apply(this,arguments)}):o.saveAttachments(),r.ignoreAttachments=!0,t.PlaceModel.__super__.save.call(this,l,r)},saveAttachments:function(){this.attachmentCollection.each(function(t){t.isNew()&&t.save()})},parse:function(t){var e=_.clone(t.properties);return e.geometry=_.clone(t.geometry),e},sync:function(t,e,n){var a;return("create"===t||"update"===t)&&(a={type:"Feature",geometry:e.get("geometry"),properties:_.omit(e.toJSON(),"geometry")},n.data=JSON.stringify(a),n.contentType="application/json"),Backbone.sync(t,e,n)}}),t.PlaceCollection=t.PaginatedCollection.extend({url:"/api/places",model:t.PlaceModel,resultsAttr:"features",fetchByIds:function(t,e){var n=_.result(this,"url");1===t.length?this.fetchById(t[0],e):(t=_.map(t,function(t){return encodeURIComponent(t)}),e=e?_.clone(e):{},e.url=n+("/"===n.charAt(n.length-1)?"":"/")+t.join(","),this.fetch(_.extend({remove:!1},e)))},fetchById:function(e,n){n=n?_.clone(n):{};var a=this,s=new t.PlaceModel,r=n.success;s.id=e,s.collection=a,n.success=function(){var t=Array.prototype.slice.call(arguments);a.add(s),r&&r.apply(this,t)},s.fetch(n)}}),t.AttachmentModel=Backbone.Model.extend({idAttribute:"name",initialize:function(t,e){this.options=e},isNew:function(){return this.get("saved")!==!0},save:function(t,e,a){var s=n(t,e,a),r=_.extend(this.attributes,s.attrs);return this._attachBlob(r.blob,r.name,s.options)},_attachBlob:function(n,a,s){var r=new FormData,i=this,o=t.Util.wrapHandler("progress",this,s.progress),c=e.ajaxSettings.xhr();r.append("file",n),r.append("name",a),s=s||{},e.ajax({url:this.collection.url(),type:"POST",xhr:function(){return c.upload&&c.upload.addEventListener("progress",o,!1),c},success:function(){var t=Array.prototype.slice.call(arguments);t[0].saved=!0,i.set({saved:!0}),s.success&&s.success.apply(this,t)},error:s.error,data:r,cache:!1,contentType:!1,processData:!1})}}),t.AttachmentCollection=Backbone.Collection.extend({model:t.AttachmentModel,initialize:function(t,e){this.options=e},url:function(){var t=this.options.thingModel,e=t.url();return e+"/attachments"}}),t.ActionCollection=t.PaginatedCollection.extend({url:"/api/actions",comparator:function(t,e){return t.get("created_datetime")>e.get("created_datetime")?-1:1}})})(Shareabouts,jQuery),jQuery(document).ajaxSend(function(t,e,n){function a(t){var e=null;if(document.cookie&&""!==document.cookie)for(var n=document.cookie.split(";"),a=0;n.length>a;a++){var s=jQuery.trim(n[a]);if(s.substring(0,t.length+1)===t+"="){e=decodeURIComponent(s.substring(t.length+1));break}}return e}function s(t){var e=document.location.host,n=document.location.protocol,a="//"+e,s=n+a;return t==s||t.slice(0,s.length+1)==s+"/"||t==a||t.slice(0,a.length+1)==a+"/"||!/^(\/\/|http:|https:).*/.test(t)}function r(t){return/^(GET|HEAD|OPTIONS|TRACE)$/.test(t)}!r(n.type)&&s(n.url)&&e.setRequestHeader("X-CSRFToken",a("csrftoken")),"DELETE"===n.type&&(e.setRequestHeader("Content-Type","application/json"),n.data="{}")});