var Shareabouts=Shareabouts||{};(function(t,e){"use strict";var n=function(t,e,n){var a;return null===t||_.isObject(t)?(a=t,n=e):null!==t&&((a={})[t]=e),n=n?_.clone(n):{},{options:n,attrs:a}};t.PaginatedCollection=Backbone.Collection.extend({parse:function(t){return this.metadata=t.metadata,t.results},fetchNextPage:function(e,n){var a,o=this;this.metadata.next&&(a=function(){return o.metadata.next},t.Utils.patch(this,{url:a},function(){o.fetch({remove:!1,success:e,error:n})}))}}),t.SubmissionCollection=t.PaginatedCollection.extend({initialize:function(t,e){this.options=e},url:function(){var t=this.options.submissionType,e=this.options.placeModel&&this.options.placeModel.id;if(!t)throw Error("submissionType option is required.");if(!e)throw Error("Place model id is not defined. You must save the place before saving its "+t+".");return"/api/places/"+e+"/"+t}}),t.PlaceModel=Backbone.Model.extend({initialize:function(){var e;this.submissionSets={},_.each(this.get("submission_sets"),function(e,n){this.submissionSets[n]=new t.SubmissionCollection(e,{placeModel:this})},this),e=this.get("attachments")||[],this.attachmentCollection=new t.AttachmentCollection(e,{thingModel:this})},set:function(e,a,o){var i=n(e,a,o),r=this;return _.isArray(i.attrs.attachments)&&this.attachmentCollection&&!i.options.ignoreAttachnments&&this.attachmentCollection.reset(i.attrs.attachments),_.each(i.attrs.submissions,function(t){var e;_.isArray(t)&&(e=_.first(t).type,e===r.collection.options.responseType&&r.responseCollection?r.responseCollection.reset(t):e===r.collection.options.supportType&&r.supportCollection&&r.supportCollection.reset(t))}),t.PlaceModel.__super__.set.call(this,i.attrs,i.options)},save:function(a,o,i){var r,s=this,c=n(a,o,i),l=c.attrs;i=c.options,this.isNew()?(r=i.success||e.noop,i.success=function(){s.saveAttachments(),r.apply(this,arguments)}):s.saveAttachments(),i.ignoreAttachnments=!0,t.PlaceModel.__super__.save.call(this,l,i)},saveAttachments:function(){this.attachmentCollection.each(function(t){t.isNew()&&t.save()})},parse:function(t){var e=_.clone(t.properties);return e.geometry=_.clone(t.geometry),e},sync:function(t,e,n){var a;return("create"===t||"update"===t)&&(a={type:"Feature",geometry:e.get("geometry"),properties:_.omit(e.toJSON(),"geometry")},n.data=JSON.stringify(a),n.contentType="application/json"),Backbone.sync(t,e,n)}}),t.PlaceCollection=t.PaginatedCollection.extend({url:"/api/places",model:t.PlaceModel,parse:function(t){return this.metadata=t.metadata,t.features}}),t.AttachmentModel=Backbone.Model.extend({idAttribute:"name",initialize:function(t,e){this.options=e},save:function(t,e,a){var o=n(t,e,a),i=_.extend(this.attributes,o.attrs);return this._attachBlob(i.blob,i.name,o.options)},_attachBlob:function(n,a,o){var i=new FormData,r=t.Util.wrapHandler("progress",this,o.progress),s=e.ajaxSettings.xhr();i.append("file",n),i.append("name",a),o=o||{},e.ajax({url:this.collection.url(),type:"POST",xhr:function(){return s.upload&&s.upload.addEventListener("progress",r,!1),s},success:o.success,error:o.error,data:i,cache:!1,contentType:!1,processData:!1})}}),t.AttachmentCollection=Backbone.Collection.extend({model:t.AttachmentModel,initialize:function(t,e){this.options=e},url:function(){var t=this.options.thingModel,e=t.url();return e+"/attachments"}}),t.ActionCollection=t.PaginatedCollection.extend({url:"/api/actions"})})(Shareabouts,jQuery),jQuery(document).ajaxSend(function(t,e,n){function a(t){var e=null;if(document.cookie&&""!==document.cookie)for(var n=document.cookie.split(";"),a=0;n.length>a;a++){var o=jQuery.trim(n[a]);if(o.substring(0,t.length+1)===t+"="){e=decodeURIComponent(o.substring(t.length+1));break}}return e}function o(t){var e=document.location.host,n=document.location.protocol,a="//"+e,o=n+a;return t==o||t.slice(0,o.length+1)==o+"/"||t==a||t.slice(0,a.length+1)==a+"/"||!/^(\/\/|http:|https:).*/.test(t)}function i(t){return/^(GET|HEAD|OPTIONS|TRACE)$/.test(t)}!i(n.type)&&o(n.url)&&e.setRequestHeader("X-CSRFToken",a("csrftoken")),"DELETE"===n.type&&(e.setRequestHeader("Content-Type","application/json"),n.data="{}")});